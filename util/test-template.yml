variables:
  BINARY_NAME: ""
  BINARY_PATH: ""
  BINARY_EXTENSION: ""
  BUILD_DIR: build

.test_common:
  stage: test
  script:
    - ${BUILD_DIR}/${BINARY_PATH}/${BINARY_NAME}${BINARY_EXTENSION} 

test ios-sim:
  stage: test 
  needs: ["build ios-sim"]
  dependencies:
    - build ios-sim 
  tags:
    - ios, simulator
  script:
    - xcrun simctl boot F328EC80-2B34-4249-B445-CCF0A69D50E8 2>&1
    - xcrun simctl install F328EC80-2B34-4249-B445-CCF0A69D50E8 ${BUILD_DIR}/${BINARY_PATH}/Debug-iphonesimulator/${BINARY_NAME}${BINARY_EXTENSION}
    - xcrun simctl launch --console F328EC80-2B34-4249-B445-CCF0A69D50E8 ${BINARY_NAME}
    - xcrun simctl shutdown F328EC80-2B34-4249-B445-CCF0A69D50E8 2>&1


test dreamcast-emu:
  stage: test 
  needs: ["build dreamcast"]
  dependencies:
    - build dreamcast 
  tags:
    - dreamcast
  script:
    - exec > >(tee -a "${BUILD_DIR}/results.txt" )
    - exec 2> >(tee -a "${BUILD_DIR}/results.txt" >&2)
    - lxdream-nitro -H -d -e ${BUILD_DIR}/${BINARY_PATH}/${BINARY_NAME}/${BINARY_EXTENSION} 
    - cp ${BUILD_DIR}/results.txt ${BUILD_DIR}/results2.txt
    - grep "********************* [   PASS   ] *********************" ${BUILD_DIR}/results2.txt

test dreamcast-physical:
  stage: test 
  needs: ["build dreamcast"]
  dependencies:
    - build dreamcast 
  tags:
    - dreamcast
  script:
    - exec > >(tee -a "${BUILD_DIR}/results.txt" )
    - exec 2> >(tee -a "${BUILD_DIR}/results.txt" >&2)
    - hs100.sh -i 10.0.0.14 off
    - hs100.sh -i 10.0.0.14 on 
    - sleep 30
    - dc-tool-ip -t 10.0.0.18 -x ${BUILD_DIR}/${BINARY_PATH}/${BINARY_NAME}${BINARY_EXTENSION} 
    - hs100.sh -i 10.0.0.14 off
    - cp ${BULD_DIR}/results.txt ${BUILD_DIR}/results2.txt
    - grep "********************* [   PASS   ] *********************" ${BUILD_DIR}/results2.txt


test debian-gcc:
  extends: .test_common
  needs: ["build debian-gcc"]
  dependencies:
    - build debian-gcc
  tags:
    - linux, gcc
    
test debian-clang:
  extends: .test_common
  needs: ["build debian-clang"]
  dependencies:
    - build debian-clang
  tags:
    - linux, clang

test win-msvc:
  extends: .test_common
  needs: ["build win-msvc"]
  dependencies:
    - build win-msvc
  tags:
    - win10, visual-studio

test win-mingw:
  extends: .test_common
  needs: ["build win-mingw"]
  dependencies:
    - build win-mingw
  tags:
    - win10, mingw

test macos-clang:
  extends: .test_common
  needs: ["build macos-clang"]
  dependencies:
    - build macos-clang
  tags:
    - macos, clang

test macos-gcc:
  extends: .test_common
  needs: ["build macos-gcc"]
  dependencies:
    - build macos-gcc
  tags:
    - macos, gcc
